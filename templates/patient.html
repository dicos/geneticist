{% extends 'base.html' %}

{% block other_static %}
<script type="text/javascript", src="{{ STATIC_URL }}dinbror-bpopup/jquery.bpopup.js"></script>
<link href="{{ STATIC_URL }}dinbror-bpopup/style.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="{{ STATIC_URL }}dinbror-bpopup/jquery.bpopup.js"></script>
<script src="{{ STATIC_URL }}dynatree/jquery/jquery-ui.custom.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}dynatree/jquery/jquery.cookie.js" type="text/javascript"></script>

<link href="{{ STATIC_URL }}dynatree/src/skin-vista/ui.dynatree.css" rel="stylesheet" type="text/css">
<script src="{{ STATIC_URL }}dynatree/src/jquery.dynatree.js" type="text/javascript"></script>

<!-- Start_Exclude: This block is not part of the sample code -->
<link href="{{ STATIC_URL }}dynatree/doc/prettify.css" rel="stylesheet">
<script src="{{ STATIC_URL }}dynatree/doc/prettify.js" type="text/javascript"></script>
<link href="{{ STATIC_URL }}dynatree/doc/sample.css" rel="stylesheet" type="text/css">
<script src="{{ STATIC_URL }}dynatree/doc/sample.js" type="text/javascript"></script>
{{ patient_form.media }}
<script type="text/javascript">
$(document).ready(function () {
    // Code adapted from http://djangosnippets.org/snippets/1389/  
    function updateElementIndex(el, prefix, ndx) {
        var id_regex = new RegExp('(' + prefix + '-\\d+-)');
        var replacement = prefix + '-' + ndx + '-';
        if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex,
        replacement));
        if (el.id) el.id = el.id.replace(id_regex, replacement);
        if (el.name) el.name = el.name.replace(id_regex, replacement);
    }

    function updateNumberDiagnosis() {
        $("#ul_diagnosis_formset ul:visible>li.number_diagnosis").each(function(index) {
            var text = "Диагноз #" + (index + 1);
            $(this).html(text);
        })
    }

    function deleteForm(btn, prefix) {
        var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
        var maxCount = parseInt($('#id_' + prefix + '-MAX_NUM_FORMS').val());
        var initialCount = parseInt($('#id_' + prefix + '-INITIAL_FORMS').val()) + 1
        if (formCount > 1) {
            var first_element = $("#ul_diagnosis_formset>ul:first")
            if (initialCount == formCount) {
                $(btn).parent().hide().filter("input,textarea").val("");
            } else {
                $(btn).parent().remove();
            }
            var forms = $('.diagnosis_form'); // Get all the forms  
            $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
            var i = 0;
            for (formCount = forms.length; i < formCount; i++) {
                $(forms.get(i)).children(":visible").children().each(function () {
                    if ($(this).attr('type') == 'text') {
                        updateElementIndex(this, prefix, i);
                        updateNumberDiagnosis();
                    }
                });
            }
        } 
        else {
            alert("Нужно поставить пациенту диагноз!");
        }
        return false;
    }

    function show_tree_mkb(h_el) {
		$("#tree").dynatree({
			title: "Lazy loading sample",
			fx: { height: "toggle", duration: 200 },
			autoFocus: false, // Set focus to first child, when expanding or lazy-loading.
			initAjax: {
				url: "{% url 'mkb' %}"
				},

			onActivate: function(node) {
                if (!node.data.isFolder) {
                    $('input[name$="code"]', h_el).val(node.data.code);
                    $('textarea', h_el).val(node.data.name);
                    $('span.b-close').click();
                }
			},

			onLazyRead: function(node){
            	node.appendAjax({
            	    url: "{% url 'mkb' %}",
		            data: {key: node.data.key,
            		       mode: "funnyMode"
                         }
                });
			}
		});
        $('#popup_mkb').bPopup({follow: [false, false],
                                width: 1024,
                                position: [0, $(h_el).offset().top + 50],
                                positionStyle: 'absolute'});
    }

    function addForm(btn, prefix) {
        var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
        var maxCount = parseInt($('#id_' + prefix + '-MAX_NUM_FORMS').val());
        var initialCount = parseInt($('#id_' + prefix + '-INITIAL_FORMS').val()) + 1
        if (formCount < maxCount) {
            var element = $("#ul_diagnosis_formset>ul:first").siblings().last().prev()
            var row = element.clone(false).get(0);
            $(row).removeAttr('id').hide().insertAfter(element).slideDown(300).click(function() {
                show_tree_mkb(this)
            });

            $(".errorlist", row).remove();
            $(row).children().removeClass("error");

            $(row).children().children().each(function () {
                updateElementIndex(this, prefix, formCount);
                $(this).val("");
                updateNumberDiagnosis();
            });

            $(row).find(".delete").click(function () {
                return deleteForm(this, prefix);
            });
            $("#id_" + prefix + "-TOTAL_FORMS").val(formCount + 1);
        } 
        else {
            alert("Больше диагнозов нельзя добавлять пациенту");
        }
        return false;
    }
    // Register the click event handlers
    $("#add").click(function () {
        return addForm(this, "diagnosis");
    });

    $(".delete").click(function () {
        return deleteForm(this, "diagnosis");
    });
    $('ul.diagnosis_form').click(function() {
        show_tree_mkb(this)
    });
    $("#diagnosis_form_0").siblings().each(function(index) {
        var element_id = $("#id_diagnosis-" + index +"-id");
        var value = element_id.val()
        if (value == "" || value == undefined) {
            element_id.parent().remove();
        } else {
            $("#li_diagnosis-" + index + "-delete").remove();
        }
    })

});
</script>
{% endblock %}

{% block content %}
<div id="popup_mkb" class="hide">
<div id="tree">&nbsp;</div>
<span class="button b-close"><span>X</span></span>
</div>

<form action='.' method="post">
{% csrf_token %}
{{ diagnosis_formset.management_form }}
<ul>
  <li id="li_first_name">{% if patient_form.first_name.errors %} {{ patient_form.first_name.errors}} {% endif %}
      {{ patient_form.first_name.label_tag }} {{ patient_form.first_name }}</li>
  <li id="li_last_name">{% if patient_form.last_name.errors %} {{ patient_form.first_name.errors}} {% endif %}
      {{ patient_form.last_name.label_tag }} {{ patient_form.last_name }}</li>
  <li id="li_patronymic">{% if patient_form.patronymic.errors %} {{ patient_form.patronymic.errors}} {% endif %}
      {{ patient_form.patronymic.label_tag }} {{ patient_form.patronymic }}</li>
  <li id="li_birthday">{% if patient_form.birthday.errors %} {{ patient_form.birthday.errors}} {% endif %}
      {{ patient_form.birthday.label_tag }} {{ patient_form.birthday }}</li>
  <li id="li_death">{% if patient_form.death.errors %} {{ patient_form.death.errors}} {% endif %}
      {{ patient_form.death.label_tag }} {{ patient_form.death }}</li>
  <li id="li_seria_policy">{% if patient_form.seria_policy.errors %} {{ patient_form.seria_policy.errors}} {% endif %}
      {{ patient_form.seria_policy.label_tag }} {{ patient_form.seria_policy }}</li>
  <li id="li_number_policy">{% if patient_form.number_policy.errors %} {{ patient_form.number_policy.errors}} {% endif %}
      {{ patient_form.number_policy.label_tag }} {{ patient_form.number_policy }}</li>
  <li id="li_code_insurance_company">{% if patient_form.code_insurance_company.errors %} {{ patient_form.code_insurance_company.errors}} {% endif %}
      {{ patient_form.code_insurance_company.label_tag }} {{ patient_form.code_insurance_company }}</li>
  <!-- Нужно сюда прикрепить КЛАДР -->
  <li id="li_registration">{% if patient_form.registration.errors %} {{ patient_form.registration.errors}} {% endif %}
      {{ patient_form.registration.label_tag }} {{ patient_form.registration }}</li>
  <li id="li_residence">{% if patient_form.residence.errors %} {{ patient_form.residence.errors}} {% endif %}
      {{ patient_form.residence.label_tag }} {{ patient_form.residence }}</li>
  <li id="li_allocate_lpu">{% if patient_form.allocate_lpu.errors %} {{ patient_form.allocate_lpu.errors}} {% endif %}
      {{ patient_form.allocate_lpu.label_tag }} {{ patient_form.allocate_lpu }}</li>
  <ul id="ul_diagnosis_formset">
    <li><b>Диагноз</b></li>
    {% for d_form in diagnosis_formset.forms %}
        <ul id="diagnosis_form_{{ forloop.counter0 }}" class="diagnosis_form">
          <li class="number_diagnosis">Диагноз #{{ forloop.counter }}</li>
          {{ d_form.as_ul }}
          <li class="delete" id="li_diagnosis-{{ forloop.counter0 }}-delete"><a href='#'>Удалить</a></li>
        </ul>
    {% endfor %}
    <li><input type="button" value="Добавить" id="add"></li>
  </ul>
  <li id="li_comment">{% if patient_form.comment.errors %} {{ patient_form.comment.errors}} {% endif %}
      {{ patient_form.comment.label_tag }} {{ patient_form.comment }}</li>
  <li id="li_social_status">{% if patient_form.social_status.errors %} {{ patient_form.social_status.errors}} {% endif %}
      {{ patient_form.social_status.label_tag }} {{ patient_form.social_status }}</li>
  <li id="li_special_cure">{% if patient_form.special_cure.errors %} {{ patient_form.special_cure.errors}} {% endif %}
      {{ patient_form.special_cure.label_tag }} {{ patient_form.special_cure }}</li>
  <li id="li_type">{% if patient_form.type.errors %} {{ patient_form.type.errors}} {% endif %}
      {{ patient_form.type.label_tag }} {{ patient_form.type }}</li>
  <li id="li_gender">{% if patient_form.gender.errors %} {{ patient_form.gender.errors}} {% endif %}
      {{ patient_form.gender.label_tag }} {{ patient_form.gender }}</li>
  <li id="li_date_registration">{% if patient_form.date_registration.errors %} {{ patient_form.date_registration.errors}} {% endif %}
      {{ patient_form.date_registration.label_tag }} {{ patient_form.date_registration }}</li>
  {% for visit in visits_qs %}
    {% if visit.is_add %}
     Первичное посещение 
    {% endif %}
    {{ visit }}
  {% endfor %}
  {{ visit_form.as_ul }}
</ul>
<input type="submit", value="Отправить">
</form>
{% endblock %}
